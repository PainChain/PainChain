// PainChain v2 Database Schema
// Multi-tenant event aggregation platform

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// Multi-tenant support (for SaaS tier)
model Tenant {
  id            String   @id @default(cuid())
  slug          String   @unique  // "customer-id" for customer-id.painchain.io
  name          String
  createdAt     DateTime @default(now())

  // Domain-based auto-joining for OIDC
  // Example: ["acme.com", "acme.co.uk"]
  // Users with @acme.com will auto-join this tenant
  domains       String[] @default([])

  integrations  Integration[]
  events        Event[]
  projects      Project[]
  teams         Team[]
  users         User[]        // Users belonging to this tenant
  invitations   TenantInvitation[]

  @@map("tenants")
}

// User-registered integrations (SaaS tier: users provide API keys)
// Or connector instances (Free tier: running containers)
model Integration {
  id            String   @id @default(cuid())
  tenantId      String?  // null for free tier (single tenant)
  tenant        Tenant?  @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  type          String   // "github", "gitlab", "kubernetes"
  name          String   // User-friendly name: "ACME GitHub", "Production K8s"

  // Configuration (API keys, repos to watch, polling settings)
  config        Json     // { token: "...", repositories: [...], polling: {...} }

  // Status
  status        String   @default("active") // "active", "inactive", "error"
  lastSync      DateTime?
  registeredAt  DateTime @default(now())

  events        Event[]  // Events created by this integration

  @@map("integrations")
}

model Event {
  id            String   @id @default(cuid())
  tenantId      String?  // null for free tier
  tenant        Tenant?  @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  integrationId String?       // Which integration created this event
  integration   Integration?  @relation(fields: [integrationId], references: [id], onDelete: SetNull)

  externalId    String?  // Source system ID for deduplication (e.g., github-event-123)

  title         String
  connector     String   // "github", "gitlab", "kubernetes"
  project       String   // "acme/backend-api", "prod-cluster/default"
  timestamp     DateTime
  data          Json     // Flexible JSON data
  createdAt     DateTime @default(now())

  @@unique([integrationId, externalId], name: "integration_external_id")
  @@index([tenantId, connector, project, timestamp])
  @@index([tenantId, timestamp])
  @@index([timestamp])
  @@index([integrationId])
  @@index([externalId])
  @@map("events")
}

model Project {
  id          String   @id @default(cuid())
  tenantId    String?  // null for free tier
  tenant      Tenant?  @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  name        String   // "acme/backend-api", "prod-cluster/default"
  connector   String   // "github", "gitlab", "kubernetes"
  tags        String[] // Tags defined in connector config for this project
  createdAt   DateTime @default(now())

  @@unique([tenantId, name, connector])
  @@map("projects")
}

// Connector type metadata (self-registered by connectors on startup)
model ConnectorType {
  id            String   @id // "github", "gitlab", "kubernetes"
  displayName   String
  color         String?  // Hex color for UI badges
  logo          String?  // Logo filename
  description   String?
  configSchema  Json     // JSON schema for integration configuration form
  registeredAt  DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@map("connector_types")
}

// Teams for organizing integrations by tags
model Team {
  id          String   @id @default(cuid())
  tenantId    String?
  tenant      Tenant?  @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  name        String   // Immutable team name (becomes first tag)
  tags        String[] // Additional tags for filtering
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([tenantId, name])
  @@index([tenantId])
  @@map("teams")
}

// ============================================
// AUTHENTICATION & USER MANAGEMENT
// ============================================

// User accounts (supports both basic auth and OIDC)
model User {
  id            String   @id @default(cuid())
  email         String   @unique
  emailVerified Boolean  @default(false)
  passwordHash  String?  // bcrypt hash (null for OIDC-only users)

  // Profile information
  firstName     String?
  lastName      String?
  displayName   String?
  avatarUrl     String?

  // Account metadata
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  lastLoginAt   DateTime?
  isActive      Boolean  @default(true)

  // Multi-tenancy: Users belong to ONE tenant
  tenantId      String
  tenant        Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // RBAC (role-based access control)
  role          String   @default("member") // "owner", "admin", "member", "viewer"

  // Invitation tracking
  invitedBy     String?    // User ID who invited this user
  invitedAt     DateTime?  // When the user was invited

  // Relations
  sessions      Session[]
  oidcAccounts  OIDCAccount[]

  @@index([tenantId])
  @@index([email])
  @@index([tenantId, email])
  @@map("users")
}

// OIDC accounts linked to users
model OIDCAccount {
  id             String   @id @default(cuid())
  userId         String
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  providerId     String   // Links to OIDCProvider.id (e.g., "google", "okta-prod")
  providerUserId String   // User's ID in provider system (sub claim)
  claims         Json     // Full OIDC claims from userinfo endpoint

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  lastUsedAt     DateTime @default(now())

  @@unique([providerId, providerUserId])
  @@index([userId])
  @@index([providerId])
  @@map("oidc_accounts")
}

// OIDC provider configuration (synced from env vars on startup)
model OIDCProvider {
  id               String   @id // e.g., "google", "okta-prod", "azure"
  name             String   // "Google Workspace"
  iconUrl          String?  // URL to provider icon

  // OIDC configuration
  issuer           String
  clientId         String
  clientSecret     String
  authorizationUrl String
  tokenUrl         String
  userinfoUrl      String
  scopes           String[] @default(["openid", "email", "profile"])

  // Tenant claim mapping
  tenantClaimPath  String @default("tenant_id") // JSON path to extract tenant from claims

  // Provider metadata
  isEnabled        Boolean  @default(true)
  displayOrder     Int      @default(0) // For UI ordering
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@index([isEnabled])
  @@map("oidc_providers")
}

// Session management (JWT + database-backed for revocation)
model Session {
  id             String   @id @default(cuid())
  userId         String
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  token          String   @unique // JWT token ID (jti claim) for revocation
  expiresAt      DateTime

  // Security metadata
  ipAddress      String?
  userAgent      String?

  // Session lifecycle
  createdAt      DateTime @default(now())
  lastActivityAt DateTime @default(now())
  revokedAt      DateTime?

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
  @@map("sessions")
}

// Tenant invitations (shareable links, no email sending)
model TenantInvitation {
  id        String   @id @default(cuid())
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Invitation details
  token     String   @unique @default(cuid()) // Shareable token for invite URL
  role      String   @default("member")       // Role for invited user: "owner", "admin", "member", "viewer"

  // Who created this invite
  createdBy String   // User ID of creator
  createdAt DateTime @default(now())

  // Expiration (7 days default)
  expiresAt DateTime

  // Usage tracking
  usedBy    String?   // User ID who accepted this invitation
  usedAt    DateTime? // When the invitation was accepted
  maxUses   Int       @default(1) // How many people can use this link (1 = single-use, >1 = multi-use)
  useCount  Int       @default(0)

  // Revocation
  isRevoked Boolean   @default(false)
  revokedAt DateTime?
  revokedBy String?   // User ID who revoked

  @@index([token])
  @@index([tenantId])
  @@index([createdBy])
  @@map("tenant_invitations")
}
